<van-toast id="van-toast" />

<view class="container">
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#1eb1f7" sticky>
    
    <!-- Tab 1: Freight Query (Existing Sender Logic) -->
    <van-tab title="运费试算">
      <!-- Unified Query Card -->
      <view class="query-card" style="margin-top: 20rpx;">
        <!-- Route Section using van-cell-group -->
        <!-- Route Section using van-cell-group -->
        <van-cell-group inset title="行程信息">
          <van-cell
            title="出发地"
            value="{{ departure || '请选择' }}"
            is-link
            bind:click="onShowDepPicker"
            icon="guide-o"
          />
          <van-cell
            title="目的地"
            value="{{ searchQuery || '请选择' }}"
            is-link
            border="{{ false }}"
            bind:click="onShowDestPicker"
            icon="location-o"
          />
        </van-cell-group>
        
        <!-- Departure Picker Popup -->
        <van-popup show="{{ showDepPicker }}" position="bottom" round bind:close="onCloseDepPicker">
            <van-picker
              columns="{{ cityColumns }}"
              show-toolbar
              title="选择出发地"
              bind:confirm="onConfirmDep"
              bind:cancel="onCloseDepPicker"
            />
        </van-popup>

        <!-- Destination Picker Popup -->
        <van-popup show="{{ showDestPicker }}" position="bottom" round bind:close="onCloseDestPicker">
            <van-picker
              columns="{{ cityColumns }}"
              show-toolbar
              title="选择目的地"
              bind:confirm="onConfirmDest"
              bind:cancel="onCloseDestPicker"
            />
        </van-popup>

        <!-- Category & Weight Section -->
        <van-cell-group inset title="物品信息" custom-style="margin-top: 24rpx;">
          <van-cell
            title="物品品类"
            value="{{ categories[categoryIndex] || '请选择' }}"
            is-link
            bind:click="onShowCategorySheet"
          />
          <van-field
            value="{{ itemWeight }}"
            label="预估重量"
            type="digit"
            placeholder="输入重量"
            bind:change="onWeightInput"
            border="{{ false }}"
            use-button-slot
          >
            <view slot="button" style="color: #333; font-weight: bold;">KG</view>
          </van-field>
        </van-cell-group>

        <!-- AI Recognition Button -->
        <view style="margin-top: 24rpx; padding: 0 24rpx;">
          <van-button 
            plain 
            type="info" 
            icon="scan" 
            size="small"
            bind:click="onAIRecognize"
          >AI 智能识别物品</van-button>
        </view>

        <!-- Agreement Section -->
        <view class="agreement-box" style="margin-top: 30rpx;">
          <van-checkbox value="{{ agreed }}" bind:change="onAgreementChange" shape="round" icon-size="32rpx" checked-color="#1eb1f7">
            同意 <text class="link-text">《禁止带货清单》</text>
          </van-checkbox>
        </view>

        <!-- Action Button -->
        <view class="action-area" style="margin-top: 30rpx;">
          <van-button type="info" block round size="large" bind:click="onSearchOrAdd" color="linear-gradient(to right, #4bb0ff, #6149f6)">查询报价</van-button>
          <view class="disclaimer">*结果仅供参考</view>
        </view>
      </view>

      <!-- Category Action Sheet -->
      <van-action-sheet
        show="{{ showCategorySheet }}"
        actions="{{ categoryActions }}"
        bind:close="onCloseCategorySheet"
        bind:select="onSelectCategory"
        cancel-text="取消"
        close-on-click-action
      />

      <!-- Results Section and Fallback (Reused Logic) -->
      <view class="flights-list" wx:if="{{filteredFlights.length > 0 || showFallback}}">
        <!-- Direct Results -->
        <block wx:if="{{filteredFlights.length > 0}}">
          <view class="section-subtitle">匹配航班</view>
          <block wx:for="{{filteredFlights}}" wx:key="id">
            <view class="flight-card" bind:tap="onGoToDetail" data-id="{{item.id}}">
              <view class="flight-header">
                <text class="flight-no">{{item.flightNo}}</text>
                <text class="flight-price">¥{{item.pricePerKg}}/KG</text>
              </view>
              <view class="flight-body">
                <view class="flight-info">
                  <text class="label">目的地:</text>
                  <text class="value">{{item.destination}} ({{item.cityCode}})</text>
                </view>
                <view class="flight-info">
                  <text class="label">日期:</text>
                  <text class="value">{{item.date}}</text>
                </view>
                <view class="flight-info">
                  <text class="label">余量:</text>
                  <text class="value">{{item.availableWeight}} KG</text>
                </view>
              </view>

            </view>
          </block>
        </block>

        <!-- Fallback Results -->
        <view class="fallback-section" wx:if="{{showFallback}}">
          <view class="no-result">
            <van-icon name="search" size="64rpx" color="#999" />
            <text>未找到直达航班</text>
          </view>

          <view class="fallback-group">
            <view class="section-subtitle">推荐方案</view>
            <view class="fallback-card">
              <view class="fallback-header">距离最近的城市: {{nearbyCities[0].name}}</view>
              <van-button plain type="info" size="small" round bind:click="onSubscribeRoute">订阅此路线</van-button>
            </view>
          </view>
        </view>
      </view>
    </van-tab>

    <!-- Tab 2: My Shipments (Ported from Packages) -->
    <van-tab title="我寄送的">
      <view class="content-area" style="padding: 24rpx;">
        <block wx:if="{{myOrders.length > 0}}">
            <view class="form-card" wx:for="{{myOrders}}" wx:key="_id" style="margin-bottom: 24rpx;">
                <!-- Clickable area for details -->
                <view bindtap="onViewOrderDetail" data-id="{{item._id}}">
                    <view style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx;">
                      <view class="section-title" style="margin-bottom: 0;">订单: {{item.flightNo}}</view>
                      <van-tag type="{{item.status === 'cancelled' ? 'default' : 'primary'}}">{{item.status}}</van-tag>
                    </view>
                    <van-cell-group border="{{ false }}">
                      <van-cell title="路线" value="{{item.route}}" border="{{ false }}" icon="location-o" />
                      <van-cell title="重量" value="{{item.weight}}KG" border="{{ false }}" icon="bag-o" />
                      <van-cell title="报价" value="待议" border="{{ false }}" />
                      <van-cell wx:if="{{item.note}}" title="备注" label="{{item.note}}" border="{{ false }}" icon="notes-o" />
                    </van-cell-group>
                </view>

                <!-- Action section (outside details click area) -->
                <view class="footer-btn" style="padding-top: 20rpx; display: flex; justify-content: flex-end;" wx:if="{{item.status !== 'cancelled'}}">
                  <van-button 
                    size="small" 
                    plain 
                    round
                    type="warning" 
                    bind:click="onCancelOrder" 
                    data-id="{{item._id}}"
                  >取消订单</van-button>
                </view>
            </view>
        </block>
        <block wx:else>
            <van-empty description="暂无寄件订单" />
        </block>
      </view>
    </van-tab>

  </van-tabs>
</view>