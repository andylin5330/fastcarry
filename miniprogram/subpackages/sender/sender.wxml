<van-toast id="van-toast" />

<view class="container">
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#1eb1f7" sticky>
    
    <!-- Tab 1: Freight Query (Existing Sender Logic) -->
    <van-tab title="运费试算">
      <!-- Unified Query Card -->
      <view class="query-card" style="margin-top: 20rpx;">
        <!-- Route Section -->
        <view class="route-section">
          <view class="location-box">
            <view class="input-with-icon">
                <input class="location-input" placeholder="出发地" value="{{departure}}" bindinput="onDepInput" placeholder-style="color: #bbb;" />
            </view>
            <view class="location-label">出发城市</view>
          </view>
          <view class="route-arrow">
            <text class="arrow-dashed">- -</text>
            <van-icon name="guide-o" color="#4caf50" size="40rpx" />
            <text class="arrow-dashed">- -</text>
          </view>
          <view class="location-box">
            <input class="location-input" placeholder="输入目的地" value="{{searchQuery}}" bindinput="onSearchInput" placeholder-style="color: #bbb;" />
            <view class="location-label">收货地区</view>
          </view>
        </view>

        <view class="divider"></view>

        <!-- Category Section (Picker + AI Button) -->
        <view class="category-row">
          <view class="picker-container">
              <view class="row-label">物品品类</view>
              <picker bindchange="onCategoryChange" value="{{categoryIndex}}" range="{{categories}}">
                <view class="picker-view">
                  <text class="{{categoryIndex !== null ? 'picker-value' : 'picker-placeholder'}}">{{categories[categoryIndex] || '请选择品类'}}</text>
                  <van-icon name="arrow-down" color="#999" size="24rpx" />
                </view>
              </picker>
          </view>
          
          <!-- Enhanced AI Button -->
          <view class="ai-btn" bindtap="onAIRecognize">
              <van-icon name="scan" size="36rpx" color="#fff" />
              <text class="ai-text">AI 识别</text>
          </view>
        </view>

        <!-- Weight Section -->
        <view class="input-row">
          <view class="row-label">预估重量</view>
          <input class="row-input" type="digit" placeholder="输入重量 (KG)" value="{{itemWeight}}" bindinput="onWeightInput" placeholder-style="color: #bbb;" />
        </view>

        <!-- Agreement Section -->
        <view class="agreement-box">
            <van-checkbox value="{{ agreed }}" bind:change="onAgreementChange" shape="round" icon-size="28rpx" checked-color="#1eb1f7">
              同意 <text class="link-text">《禁止带货清单》</text>
            </van-checkbox>
          </view>

        <!-- Action Button -->
        <view class="action-area">
          <button class="search-btn" bindtap="onSearchOrAdd">查询报价</button>
          <view class="disclaimer">*结果仅供参考</view>
        </view>
      </view>

      <!-- Results Section and Fallback (Reused Logic) -->
      <view class="flights-list" wx:if="{{filteredFlights.length > 0 || showFallback}}">
        <!-- Direct Results -->
        <block wx:if="{{filteredFlights.length > 0}}">
          <view class="section-subtitle">匹配航班</view>
          <block wx:for="{{filteredFlights}}" wx:key="id">
            <view class="flight-card">
              <view class="flight-header">
                <text class="flight-no">{{item.flightNo}}</text>
                <text class="flight-price">¥{{item.pricePerKg}}/KG</text>
              </view>
              <view class="flight-body">
                <view class="flight-info">
                  <text class="label">目的地:</text>
                  <text class="value">{{item.destination}} ({{item.cityCode}})</text>
                </view>
                <view class="flight-info">
                  <text class="label">日期:</text>
                  <text class="value">{{item.date}}</text>
                </view>
                <view class="flight-info">
                  <text class="label">余量:</text>
                  <text class="value">{{item.availableWeight}} KG</text>
                </view>
              </view>
              <van-button type="primary" size="small" block round bind:click="onRequestCarry" data-item="{{item}}">请求带货</van-button>
            </view>
          </block>
        </block>

        <!-- Fallback Results -->
        <view class="fallback-section" wx:if="{{showFallback}}">
          <view class="no-result">
            <van-icon name="search" size="64rpx" color="#999" />
            <text>未找到直达航班</text>
          </view>

          <view class="fallback-group">
            <view class="section-subtitle">推荐方案</view>
            <view class="fallback-card">
              <view class="fallback-header">距离最近的城市: {{nearbyCities[0].name}}</view>
              <van-button plain type="info" size="small" round bind:click="onSubscribeRoute">订阅此路线</van-button>
            </view>
          </view>
        </view>
      </view>
    </van-tab>

    <!-- Tab 2: My Shipments (Ported from Packages) -->
    <van-tab title="我寄送的">
      <view class="content-area" style="padding: 24rpx;">
        <block wx:if="{{myOrders.length > 0}}">
            <view class="card-wrap" wx:for="{{myOrders}}" wx:key="_id" style="margin-bottom: 24rpx;">
                <van-card
                    tag="{{item.status}}"
                    price="待议"
                    desc="路线: {{item.route}}"
                    title="航班: {{item.flightNo}}"
                    thumb="/images/icons/box.png" 
                >
                    <view slot="tags">
                        <van-tag plain type="primary" style="margin-right: 10rpx;">重量: {{item.weight}}KG</van-tag>
                        <van-tag plain type="warning">备注: {{item.note}}</van-tag>
                    </view>
                    <view slot="footer">
                        <text class="date-text" style="font-size: 24rpx; color: #999; margin-right: 20rpx;">{{item.createTime_fmt}}</text>
                        <van-button 
                          wx:if="{{item.status !== 'cancelled'}}" 
                          size="mini" 
                          plain 
                          type="warning" 
                          bind:click="onCancelOrder" 
                          data-id="{{item._id}}"
                        >取消订单</van-button>
                    </view>
                </van-card>
            </view>
        </block>
        <block wx:else>
            <van-empty description="暂无寄件订单" />
        </block>
      </view>
    </van-tab>

  </van-tabs>
</view>