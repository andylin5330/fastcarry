<van-toast id="van-toast" />

<view class="container">
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#1eb1f7" sticky>
    
    <!-- Tab 1: Post Trip (Existing Carrier Form) -->
    <van-tab title="发布行程">
      <view class="wizard-container">
        <van-steps steps="{{ steps }}" active="{{ currentStep }}" active-color="#1eb1f7" />

        <view class="step-content">
            <!-- Step 1: Flight -->
            <view class="step-view" wx:if="{{currentStep === 0}}">
                <view class="section-title">航班信息</view>
                <van-cell-group inset>
                    <van-field
                      value="{{ flightNo }}"
                      label="航班号"
                      placeholder="例如: CA981"
                      border="{{ false }}"
                      bind:change="onFlightInput"
                    />
                </van-cell-group>
            </view>

            <!-- Step 2: Route -->
            <view class="step-view" wx:if="{{currentStep === 1}}">
                <view class="section-title">行程地点</view>
                <van-cell-group inset>
                    <van-cell
                      title="出发地"
                      value="{{ departure || '请选择' }}"
                      is-link
                      bind:click="onShowDepPicker"
                    />
                    <van-cell
                      title="目的地"
                      value="{{ destination || '请选择' }}"
                      is-link
                      border="{{ false }}"
                      bind:click="onShowDestPicker"
                    />
                </van-cell-group>
            </view>

            <!-- Departure Picker Popup -->
            <van-popup show="{{ showDepPicker }}" position="bottom" round bind:close="onCloseDepPicker">
                <van-picker
                  columns="{{ cityColumns }}"
                  show-toolbar
                  title="选择出发地"
                  bind:confirm="onConfirmDep"
                  bind:cancel="onCloseDepPicker"
                />
            </van-popup>

            <!-- Destination Picker Popup -->
            <van-popup show="{{ showDestPicker }}" position="bottom" round bind:close="onCloseDestPicker">
                <van-picker
                  columns="{{ cityColumns }}"
                  show-toolbar
                  title="选择目的地"
                  bind:confirm="onConfirmDest"
                  bind:cancel="onCloseDestPicker"
                />
            </van-popup>

            <!-- Step 3: Address -->
            <view class="step-view" wx:if="{{currentStep === 2}}">
                 <view class="section-title-row">
                    <view class="section-title" style="margin-bottom: 0;">收件地址</view>
                    <view class="use-saved-link" bindtap="onSelectSavedAddress">
                      <van-icon name="location-o" /> 使用已存地址
                    </view>
                  </view>
                   <van-field
                      value="{{ address }}"
                      type="textarea"
                      placeholder="请输入方便交接的收件地址..."
                      autosize
                      border="{{ false }}"
                      bind:change="onAddressInput"
                      custom-style="background: #f9f9f9; border-radius: 12rpx; padding: 20rpx;"
                    />
            </view>

            <!-- Step 4: Space -->
            <view class="step-view" wx:if="{{currentStep === 3}}">
                <view class="section-title">行李空间</view>
                <van-radio-group value="{{ spaceType }}" bind:change="onSpaceTypeChange" direction="horizontal" class="radio-group-spaced">
                    <van-radio name="empty" checked-color="#1eb1f7">空箱子</van-radio>
                    <van-radio name="remaining" checked-color="#1eb1f7">剩余空间</van-radio>
                    <van-radio name="abnormal" checked-color="#ff9800">异常件</van-radio>
                </van-radio-group>

                <view class="conditional-area" wx:if="{{spaceType === 'remaining'}}">
                     <view class="divider"></view>
                     <van-field
                        value="{{ remainingWeight }}"
                        label="剩余重量"
                        placeholder="0"
                        type="digit"
                        bind:change="onWeightInput"
                        use-button-slot
                      >
                        <view slot="button" style="color: #333; font-weight: bold;">KG</view>
                      </van-field>
                      <view style="font-size: 24rpx; color: #999; margin-left: 32rpx; margin-bottom: 20rpx;">平台指导价: 100元/kg</view>
                      
                      <view class="volume-row">
                         <text class="volume-label">目测剩余体积</text>
                         <view class="chips-container">
                            <van-tag 
                              wx:for="{{volumeOptions}}" 
                              wx:key="*this"
                              type="{{volumeRatio === item ? 'primary' : 'default'}}"
                              plain="{{volumeRatio !== item}}"
                              round
                              size="medium"
                              bindtap="onVolumeSelect"
                              data-value="{{item}}"
                              custom-class="volume-tag"
                            >{{item}}</van-tag>
                         </view>
                      </view>
                </view>
                 <view class="conditional-area" wx:if="{{spaceType === 'abnormal'}}">
                     <view class="divider"></view>
                     <view class="tips">适合携带形状不规则或超大件物品</view>
                  </view>
            </view>
        </view>

        <!-- Navigation Buttons -->
        <!-- Navigation Buttons -->
        <view class="wizard-actions">
            <!-- Spacer for Step 0 -->
            <view wx:if="{{currentStep === 0}}" style="width: 40%;"></view>
            
            <!-- Prev Button Wrapper -->
            <view wx:if="{{currentStep > 0}}" style="width: 40%;">
                <van-button 
                  plain 
                  round 
                  block
                  type="default" 
                  bind:click="prevStep" 
                >上一步</van-button>
            </view>
            
            <!-- Next Button Wrapper -->
            <view wx:if="{{currentStep < 3}}" style="width: 40%;">
                <van-button 
                  round 
                  block
                  type="info" 
                  bind:click="nextStep" 
                >下一步</van-button>
            </view>
            
            <!-- Submit Button Wrapper -->
            <view wx:if="{{currentStep === 3}}" style="width: 40%;">
                <van-button 
                  round 
                  block
                  type="info" 
                  bind:click="onSubmit" 
                >发布行程</van-button>
            </view>
        </view>
      </view>
    </van-tab>

    <!-- Tab 2: My Trips (Ported from Packages) -->
    <van-tab title="我发布的">
      <view class="content-area" style="padding: 24rpx;">
          <block wx:if="{{myTrips.length > 0}}">
             <view class="form-card" wx:for="{{myTrips}}" wx:key="_id" style="margin-bottom: 24rpx;">
                <view class="section-title">带货号: {{item.carryingNo || '待生成'}}</view>
                <van-cell-group border="{{ false }}">
                  <van-cell title="航班" value="{{item.flightNo}}" border="{{ false }}" icon="notes-o" />
                  <van-cell title="路线" value="{{item.route}}" border="{{ false }}" icon="location-o" />
                  <van-cell title="余量" value="{{item.details.weight}}KG" border="{{ false }}" icon="bag-o" />
                  <van-cell title="发布时间" value="{{item.createTime_fmt}}" border="{{ false }}" />
                </van-cell-group>
                <view class="footer-btn" style="padding-top: 20rpx; display: flex; justify-content: flex-end;">
                  <van-button 
                      size="small" 
                      type="danger" 
                      plain
                      round
                      bind:click="onRemoveTrip" 
                      data-id="{{item._id}}"
                  >下架行程</van-button>
                </view>
             </view>
          </block>
          <block wx:else>
             <van-empty description="暂无发布行程" />
          </block>
      </view>
    </van-tab>

  </van-tabs>
</view>
